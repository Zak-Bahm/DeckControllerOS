#!/bin/sh

if [ "${DEBUG:-0}" -eq 1 ]; then
	set -x
fi

run_btctl() {
	if command -v timeout >/dev/null 2>&1; then
		timeout 5 /usr/bin/bluetoothctl "$@"
	else
		/usr/bin/bluetoothctl "$@" &
		CTL_PID=$!
		for _ in 1 2 3 4 5; do
			kill -0 "$CTL_PID" >/dev/null 2>&1 || break
			sleep 1
		done
		kill "$CTL_PID" >/dev/null 2>&1 || true
		wait "$CTL_PID" >/dev/null 2>&1 || true
	fi
}

for _ in 1 2 3 4 5; do
	if run_btctl show >/dev/null 2>&1; then
		if run_btctl power on >/dev/null 2>&1; then
			[ "${DEBUG:-0}" -eq 1 ] && /usr/bin/bluetoothctl show || true
			exit 0
		fi
	fi
	sleep 1
done

if [ "${DEBUG:-0}" -eq 1 ]; then
	/usr/bin/bluetoothctl show || true
	exit 1
fi

exit 0
